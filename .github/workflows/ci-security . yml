name: Security Scan Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install dependencies (if needed)
      run: |
        if [ -f package-lock.json ]; then npm ci
        elif [ -f package.json ]; then npm install; fi

    - name: Run Snyk Scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: test --json-file-output=snyk_report.json

    - name: Summarize Snyk Report
      id: snyk_summary
      run: |
        TOTAL=$(jq '.vulnerabilities | length' snyk_report.json)
        HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' snyk_report.json)
        MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' snyk_report.json)
        LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' snyk_report.json)

        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT

    - name: Trigger Rapid7 InsightAppSec Scan
      run: |
        echo "Triggering Rapid7 scan..."
        curl -X POST https://us.api.insight.rapid7.com/ias/v1/scans \
          -H "X-Api-Key: ${{ secrets.RAPID7_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
                "app": "${{ secrets.RAPID7_APP_ID }}",
                "scanConfig": "${{ secrets.RAPID7_SCAN_CONFIG_ID }}",
                "name": "GitHub CI Security Scan"
              }'

    - name: Send Email Report via Gmail
      uses: akhil0333/action-send-mail@v3
      with:
        server_address: smtp.gmass.co
        server_port: 587
        username: ${{ secrets.EMAIL_USER }}
        password: ${{ secrets.EMAIL_PASS }}
        subject: "ğŸ”’ Security Scan Report - ${{ github.repository }}"
        to: ${{ secrets.EMAIL_TO }}
        from: GitHub CI Bot <${{ secrets.EMAIL_USER }}>
        html_body: |
          <h2>ğŸ” Security Scan Summary</h2>
          <p><strong>Repository:</strong> ${{ github.repository }}</p>
          <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
          <ul>
            <li><strong>Total vulnerabilities:</strong> ${{ steps.snyk_summary.outputs.total }}</li>
            <li><strong>High:</strong> ${{ steps.snyk_summary.outputs.high }}</li>
            <li><strong>Medium:</strong> ${{ steps.snyk_summary.outputs.medium }}</li>
            <li><strong>Low:</strong> ${{ steps.snyk_summary.outputs.low }}</li>
          </ul>
          <p>ğŸ”„ Rapid7 scan has been triggered and is running in the background.</p>
          <p>ğŸ“ Attached: <code>snyk_report.json</code></p>
        attachments: snyk_report.json
